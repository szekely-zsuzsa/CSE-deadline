---
title: "Srtoop deadline: analysis"
author: "Zsuzsa Szekely"
output: html_document: default
editor_options:
  chunk_output_type: console
---
## Load packages

```{r load packages, warning = FALSE, message = FALSE}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, osfr, lme4, BayesFactor, DescTools, sjstats, car, broom, cowplot)
```

## Load helper functions

```{r load helper functions}
source("R/utils.R")
```

# Import data

```{r, message = FALSE, warning = FALSE}
processed_rt <- read_tsv("data/deadline/processed/processed_data_rt.tsv")
processed_acc <- read_tsv("data/deadline/processed/processed_data_acc.tsv")
```

# Descriptive statistics of the sample size
## Number of participants left after exclusion

The number of participants should be the same for the reaction time and the the accuracy as well

```{r, warning = FALSE}
processed_rt %>% 
  distinct(participant_id) %>% 
  count()

processed_acc %>% 
  distinct(participant_id) %>% 
  count()
```

## Number of responses after exclusion
### For the reaction time analysis

```{r, warning = FALSE}
processed_rt %>%
  count()
```

### For the accuracy analysis

```{r, warning = FALSE}
processed_acc %>%
  count()
```

***

# Checking CSE for reaction time
## Figures of CSE for reaction time

```{r, eval= FALSE}
# prepare the cse rt plot
cse_plot_rt_data <-
  processed_rt %>%
  # create congruency text variables
  mutate(isPrevCongruent = case_when(isPrevCongruent ==  0L ~ "Incongruent",
                                     isPrevCongruent ==  1L ~ "Congruent"),
         isCongruent = case_when(congruency ==  "inc" ~ "Incongruent",
                                 congruency ==  "con" ~ "Congruent")) %>%
  # calculate mean rt of each participant
  group_by(participant_id, condition) %>%
  mutate(participant_mean_rt = mean(reaction_time, na.rm = T)) %>%
  # calculate the mean, sd and se of rt incuding all participants' results
  group_by(condition) %>%
  mutate(N = n(),
         mean_rt = mean(participant_mean_rt, na.rm = T),
         sd_rt = sd(participant_mean_rt, na.rm = T),
         se_rt = sd_rt / sqrt(N))

# creating the plot
cse_plot_rt <- cse_plot_rt_data %>% 
  ggplot(aes(x = isPrevCongruent, y = mean_rt,
             color = isCongruent,
             group = isCongruent)) +
  geom_path() +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = mean_rt - se_rt, ymax = mean_rt + se_rt), width=.1) +
  scale_color_manual(values=c("#A8D08C", "#F26C4F")) +
  # scale_y_continuous(limits = c(500, 600)) +
  # scale_x_discrete(expand=c(1, 0)) +
  # ggtitle(stringr::str_to_title()) +
  xlab("Congruency of the previous trial")+
  ylab("Mean reaction time (ms)") +
  guides(color = guide_legend(title="Congruency of \n the current trial")) 
  # + theme(legend.position = c(0.85, 0.5),
  #       axis.line = element_line(color = "black"),
  #       panel.background = element_blank(),
  #       legend.key = element_rect(colour = "transparent", fill = "white"))
```

## Saving the rt CSE figure

```{r, eval= FALSE}
ggsave("figures/deadline/rt_cse.png", width = 14.4, height = 8, plot = last_plot())
```

## Hungarian figures of CSE for reaction time

```{r, eval= FALSE}
# prepare the cse rt plot
cse_plot_rt_data_hun <-
  processed_rt %>%
  # create congruency text variables
  mutate(isPrevCongruent = case_when(isPrevCongruent ==  0L ~ "Inkongruens",
                                     isPrevCongruent ==  1L ~ "Kongruens"),
         isCongruent = case_when(congruency ==  "inc" ~ "Inkongruens",
                                 congruency ==  "con" ~ "Kongruens")) %>%
  # calculate mean rt of each participant
  group_by(participant_id, condition) %>%
  mutate(participant_mean_rt = mean(reaction_time, na.rm = T)) %>%
  # calculate the mean, sd and se of rt incuding all participants' results
  group_by(condition) %>%
  mutate(N = n(),
         mean_rt = mean(participant_mean_rt, na.rm = T),
         sd_rt = sd(participant_mean_rt, na.rm = T),
         se_rt = sd_rt / sqrt(N))

# creating the plot
cse_plot_rt_hun <- cse_plot_rt_data_hun %>% 
  ggplot(aes(x = isPrevCongruent, y = mean_rt,
             color = isCongruent,
             group = isCongruent)) +
  geom_path() +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = mean_rt - se_rt, ymax = mean_rt + se_rt), width=.1) +
  scale_color_manual(values=c("#A8D08C", "#F26C4F")) +
  # scale_y_continuous(limits = c(500, 600)) +
  # scale_x_discrete(expand=c(1, 0)) +
  # ggtitle(stringr::str_to_title()) +
  xlab("Előző próba kongruenciája")+
  ylab("Átlagos reakcióidő (ms)") +
  guides(color = guide_legend(title="Próba \nkongruenciája")) 
  # + theme(legend.position = c(0.85, 0.5),
  #       axis.line = element_line(color = "black"),
  #       panel.background = element_blank(),
  #       legend.key = element_rect(colour = "transparent", fill = "white"))
```

## Saving the rt CSE Hungarian figures

```{r, eval= FALSE}
ggsave("figures/deadline/rt_cse_hun.png", width = 14.4, height = 8, plot = last_plot())
```

# Checking CSE for accuracy in
## Figures of CSE for accuracy

```{r, eval= FALSE}
# prepare the cse rt plot
cse_plot_acc_data <-
  processed_acc %>%
  # create congruency text variables
  mutate(isPrevCongruent = case_when(isPrevCongruent ==  0L ~ "Incongruent",
                                     isPrevCongruent ==  1L ~ "Congruent"),
         isCongruent = case_when(congruency ==  "inc" ~ "Incongruent",
                                 congruency ==  "con" ~ "Congruent")) %>%
  # calculate mean rt of each participant
  group_by(participant_id, condition) %>%
  mutate(participant_mean_acc = mean(correct, na.rm = T)) %>%
  # calculate the mean, sd and se of rt incuding all participants' results
  group_by(condition) %>%
  mutate(N = n(),
         mean_acc = mean(participant_mean_acc, na.rm = T)*100,
         sd_acc = sd(participant_mean_acc, na.rm = T),
         se_acc = sd_acc / sqrt(N))

# creating the plot
cse_plot_acc <- cse_plot_acc_data %>% 
  ggplot(aes(x = isPrevCongruent, y = mean_acc,
             color = isCongruent,
             group = isCongruent)) +
  geom_path() +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = mean_acc - se_acc, ymax = mean_acc + se_acc), width=.1) +
  scale_color_manual(values=c("#A8D08C", "#F26C4F")) +
  # scale_y_continuous(limits = c(500, 600)) +
  # scale_x_discrete(expand=c(1, 0)) +
  # ggtitle(stringr::str_to_title()) +
  xlab("Congruency of the previous trial")+
  ylab("Accuracy (%)") +
  guides(color = guide_legend(title="Congruency of \n the current trial")) 
  # + theme(legend.position = c(0.85, 0.5),
  #       axis.line = element_line(color = "black"),
  #       panel.background = element_blank(),
  #       legend.key = element_rect(colour = "transparent", fill = "white"))
```

## Saving the accuracy CSE figure

```{r, eval= FALSE}
ggsave("figures/deadline/acc_cse.png", width = 14.4, height = 8, plot = last_plot())
```

## Hungarian figures of CSE for accuracy

```{r, eval= FALSE}
# prepare the cse rt plot
cse_plot_acc_data_hun <-
  processed_acc %>%
  # create congruency text variables
  mutate(isPrevCongruent = case_when(isPrevCongruent ==  0L ~ "Inkongruens",
                                     isPrevCongruent ==  1L ~ "Kongruens"),
         isCongruent = case_when(congruency ==  "inc" ~ "Inkongruens",
                                 congruency ==  "con" ~ "Kongruens")) %>%
  # calculate mean rt of each participant
  group_by(participant_id, condition) %>%
  mutate(participant_mean_acc = mean(correct, na.rm = T)) %>%
  # calculate the mean, sd and se of rt incuding all participants' results
  group_by(condition) %>%
  mutate(N = n(),
         mean_acc = mean(participant_mean_acc, na.rm = T)*100,
         sd_acc = sd(participant_mean_acc, na.rm = T),
         se_acc = sd_acc / sqrt(N))

# creating the plot
cse_plot_acc <- cse_plot_acc_data_hun %>% 
  ggplot(aes(x = isPrevCongruent, y = mean_acc,
             color = isCongruent,
             group = isCongruent)) +
  geom_path() +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = mean_acc - se_acc, ymax = mean_acc + se_acc), width=.1) +
  scale_color_manual(values=c("#A8D08C", "#F26C4F")) +
  # scale_y_continuous(limits = c(500, 600)) +
  # scale_x_discrete(expand=c(1, 0)) +
  # ggtitle(stringr::str_to_title()) +
  xlab("Előző próba kongruenciája")+
  ylab("Pontosság (%)") +
  guides(color = guide_legend(title="Próba \nkongruenciája")) 
  # + theme(legend.position = c(0.85, 0.5),
  #       axis.line = element_line(color = "black"),
  #       panel.background = element_blank(),
  #       legend.key = element_rect(colour = "transparent", fill = "white"))
```

## Saving the Hungarian accuracy CSE figure

```{r, eval= FALSE}
ggsave("figures/deadline/acc_cse_hun.png", width = 14.4, height = 8, plot = last_plot())
```








# Reaction time analyis
## I. analysis: Testing whether the CSE was present in the task
### Preprocessing data

We are calculating mean reaction time for the analysis for each participant in each condition.

```{r, warning = FALSE}
processed_rt <- processed_rt %>% 
  group_by(participant_id, condition) %>% 
  mutate(rtConditionalMean = mean(reaction_time, na.rm = TRUE)) %>%
  ungroup()
```

We are calculating the main congruency effect of the current (n) trial, the main congruency effect of the previous trial (n-1) and the interaction effect (CSE) between them for each participant.
```{r}
rt_effect_data <- processed_rt %>% 
  spread(key = condition, value = rtConditionalMean) %>%
  mutate(ii = replace_na(ii, 0),
         ic = replace_na(ic, 0),
         ci = replace_na(ci, 0),
         cc = replace_na(cc, 0)) %>% 
  mutate(congruencyEffect = ((ci + ii) / 2) - ((cc + ic) / 2), # substract the mean rt of congtuent trials from the mean rt of incongtuent trials to get the rt CE
         prevCongruencyEffect = ((ci + cc) / 2) - ((ii + ic) / 2),
         cseEffect = (ci - cc) - (ii - ic))

# check whether there's anybody with more or less than 4 values in for the effects
rt_effect_data %>% 
  group_by(participant_id) %>% 
  distinct(congruencyEffect) %>% 
  count() %>% 
  filter(n != 4) %>% 
  nrow()

rt_effect_data %>% 
  group_by(participant_id) %>% 
  distinct(prevCongruencyEffect) %>% 
  count() %>% 
  filter(n != 4) %>% 
  nrow()

rt_effect_data %>% 
  group_by(participant_id) %>% 
  distinct(cseEffect) %>% 
  count() %>% 
  filter(n != 4) %>% 
  nrow()
```

### Running the analysis

We are running a 2 × 2 repeated-measures ANOVA with mean RT as dependent variable. The two factors of the ANOVA are Previous Trial Congruency (congruent, incongruent) and Current Trial Congruency (congruent, incongruent).

```{r}
rt_anova <- processed_rt %>% 
  aov(rtConditionalMean ~ congruency * isPrevCongruent +
        Error(participant_id / (congruency * isPrevCongruent)), data = .)

# Print results
summary(rt_anova)
```

The interaction was not significant.

We are calculating the partial eta square as an effect size estimate for the ANOVA.

```{r}
rt_anova_eta <- rt_anova %>% 
  effectsize::eta_squared(., partial = TRUE)

# Print results with names
summary(rt_anova_eta)
```




***




# Accuracy analysis
## I. analysis: Testing whether the CSE was present in the different tasks
### Preprocessing data

We are calculating the accuracy for the analysis for each participant in each condition.

```{r calculating mean dev acc}
processed_acc <-
  processed_acc %>% 
  group_by(participant_id, condition) %>% 
  mutate(accConditionalMean = mean(correct, na.rm =)) %>% 
  ungroup()

processed_acc %>% 
  distinct(accConditionalMean) %>% 
  count()
```

We are calculating the main congruency effect of the current (n) trial, the main congruency effect of the previous trial (n-1) and the interaction effect (CSE) between them for each participant.

```{r}
acc_effect_data <- processed_acc %>% 
  spread(key = condition, value = accConditionalMean) %>%
  mutate(ii = replace_na(ii, 0),
         ic = replace_na(ic, 0),
         ci = replace_na(ci, 0),
         cc = replace_na(cc, 0)) %>% 
  mutate(congruencyEffect = ((cc + ic) / 2) - ((ci + ii) / 2), # substract the mean acc of incongruent trials from the mean acc of congruent trials to get the acc CE
         prevCongruencyEffect = ((ci + cc) / 2) - ((ii + ic) / 2),
         cseEffect = (cc - ci) - (ic - ii))

# check whether there's anybody with more or less than 4 values for the effects
acc_effect_data %>% 
  group_by(participant_id) %>% 
  distinct(congruencyEffect) %>% 
  count() %>% 
  filter(n != 4) %>%
  nrow()

acc_effect_data %>% 
  group_by(participant_id) %>% 
  distinct(prevCongruencyEffect) %>% 
  count() %>% 
  filter(n != 4) %>% 
  nrow()

acc_effect_data %>% 
  group_by(participant_id) %>% 
  distinct(cseEffect) %>% 
  count() %>% 
  filter(n != 4) %>%
  nrow()
```

### Running the analysis

We are running a 2 × 2 repeated-measures ANOVA with accuracy as dependent variable. The two factors of the ANOVA are Previous Trial Congruency (congruent, incongruent) and Current Trial Congruency (congruent, incongruent).

```{r}
acc_anova <- processed_acc %>% 
  aov(accConditionalMean ~ congruency * isPrevCongruent +
        Error(participant_id / (congruency * isPrevCongruent)), data = .)

# Print results
summary(acc_anova)
```

All off the effects are significant.

We are calculating the partial eta square as an effect size estimate for the ANOVA.

```{r}
acc_anova_eta <- acc_anova %>% 
  effectsize::eta_squared(., partial = TRUE)

# Print results with names
summary(acc_anova_eta)
```



***



Analysing personal deadline.

Get the mean and sd of deadlines for each participant.
```{r}
personal_deadline <- processed_acc %>% 
  group_by(participant_id) %>% 
  mutate(personal_dl_mean = mean(personalDeadline),
         personal_dl_sd = sd(personalDeadline)) %>%
  distinct(personal_dl_mean)

# plot personal deadlines per each block
personal_deadline_plot <-
  personal_deadline %>%  
  ggplot(aes(personal_dl_mean)) +
  geom_histogram() +
  stat_bin(binwidth = 40) +
  xlab("Personal mean deadline (ms)")

# save plot
ggsave("figures/deadline/personal_deadline.png", width = 14.4, height = 8, plot = last_plot())
```

Examine how personal deadlines change during the task completion (in the 4 different blocks)

```{r}
# plot personal deadlines per each block
block_deadline_plot <-
  processed_acc %>% 
  ggplot(aes(x = blockId, y = personalDeadline)) +
  geom_point() +
  xlab("Block number") +
  ylab("Personal deadline (ms)")

# save plot
ggsave("figures/deadline/deadline_block.png", width = 14.4, height = 8, plot = last_plot())
```

